<!DOCTYPE html>
<link rel="stylesheet" , href="BodyStyle.CSS">
<html lang="en">

<head>
    <title>Snake Videogame - JavaScript</title>
    <style>
        canvas {
            border: 10px solid rgb(124, 0, 0);
        }
    </style>
</head>

<body>

    <h1 style="margin: 28.3px;">Snake Game</h1>

    <nav>
        <a class="nav-item" href="index.html">Home</a>

        <a class="nav-item" href="CV.html">CV and UWB Diploma</a>

        <div class="nav-item dropdown">
            Academic Projects &#x25BE
            <div class="dropdown-content">
                <a href="bioinformatics.html">Bioinformatics</a>
                <a href="networkanalysis.html">Network Analysis</a>
                <a href="environmentalmonitoring.html">Environmental Monitoring</a>
                <a href="advancedDataVis.html">Advanced Data Visualization</a>
                <a href="dataStructuresAlgorithmsAndDiscreteMathematics.html">Data Structures, Algorithms, and Discrete
                    Mathematics</a>
            </div>
        </div>
        <div class="nav-item dropdown">
            Personal Projects &#x25BE
            <div class="dropdown-content">
                <a href="JavaScriptGame.html">Snake Game</a>
            </div>
        </div>
    </nav>

    <br>

    <h2 style="margin-bottom: 25px;">About</h2>
    <div
        style="border-style: solid; padding: 5px; border-radius: 2px; max-width: 800px; margin: auto; background-color: whitesmoke;">
        <p>
            This project is a web-based Snake game with an integrated leaderboard that tracks and displays the 5 top
            players
            and their score. I built the game logic with JavaScript, HTML, and CSS, then created a backend using
            Node.js,
            Express, and MongoDB Atlas to store data. The project demonstrates skills in
            full-stack development, database integration, REST APIs, and dynamic UI design, as well as best web-dev
            practices like using environment variables for security and structuring data for efficient data queries.
            <br><br>

            Frontend code (GitHub) <a
                href="https://github.com/jonathanmsebastiani/jonathanmsebastiani.github.io/blob/main/JavaScriptGame.html"
                target="_blank"><img src="index_Files/openInNewTapIcon.png" width="23px"
                    style="position: relative; top: 5px;" alt="GitHub link to this websites code"></a>
            &nbsp; &nbsp; | &nbsp; &nbsp;Backend code (GitHub) <a
                href="https://github.com/jonathanmsebastiani/jonathanmsebastiani.github.io/blob/main/backend"
                target="_blank"><img src="index_Files/openInNewTapIcon.png" width="23px"
                    style="position: relative; top: 5px;" alt="GitHub link to this websites code"></a>
        </p>
    </div>

    <!-- Wrapper for two-column layout -->
    <div style="
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; 
    width: 100%; 
    max-width: 1000px; 
    margin: 40px auto; 
    border-left: 2px solid black; 
    border-right: 2px solid black;
">

        <!-- Left side (How to Play) -->
        <div style="
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 0 40px; 
        border-right: 2px solid black;
    ">
            <h2 style="margin-bottom: 25px;">How to Play</h2>
            <div
                style="max-width: 300px; text-align: center; background-color: whitesmoke; padding: 15px; border: 1px solid black;">
                <ul style="
                font-size: 20px; 
                margin: 20px auto; 
                padding-left: 20px; 
                line-height: 1.6; 
                text-align: left;
            ">
                    <li style="margin-bottom: 15px;">Use the arrow keys to move.</li>
                    <li style="margin-bottom: 15px;">The more food the snake eats, the faster it will move.</li>
                    <li style="margin-bottom: 15px;">The game ends if the snake collides with itself or a wall.</li>
                </ul>
            </div>
        </div>

        <!-- Right side (Leaderboard) -->
        <div style="
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 0 40px;
    ">
            <h3 style="margin-bottom: 25px;">Top 5 Leaderboard</h3>
            <div id="leaderboard" style="width: 100%; max-width: 500px; text-align: center;">
                <table id="leaderboardTable"
                    style="border: 1px solid black; border-collapse: collapse; width: 100%; background-color: whitesmoke;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid black; padding: 8px;">Rank</th>
                            <th style="border: 1px solid black; padding: 8px;">Name</th>
                            <th style="border: 1px solid black; padding: 8px;">Score</th>
                            <th style="border: 1px solid black; padding: 8px;">Date</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr id="loadingRow">
                            <td colspan="4" style="text-align:center;">Loading<span id="loadingDots"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <hr><hr><br>

    <div>
        <button id="startBtn">Start Game</button>
        <button id="resetBtn">Reset</button>
    </div>
    <div style="margin: 15px; font-size: 1.2em;">
        Score: <span id="score">1</span>
        <br>
        Speed: <span id="speed">300</span>ms/tile
    </div>

    <div id="scoreInputDiv" style="display: none; margin-top: 20px; color: green;">
        <label for="playerNameInput">Congrats, you made it on the leaderboard! Enter your name:</label>
        <input type="text" id="playerNameInput" required>
        <button id="submitScoreBtn">Submit Score</button>
    </div>
    <br>

    <canvas id="game" width="400" height="400" style="margin-bottom: 80px;">The game canvas could not be loaded</canvas>

    <script>
        // Setup
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let gameStarted = false;

        // Grid size
        const gridSize = 20;
        const tileWidth = canvas.width / gridSize;
        let gridMatrix = createMatrix(gridSize);

        // Snake variables
        let snake = [
            [9, 9],
            [8, 9]
        ];
        let ateFood = false;
        let hitTail = false;
        let hitWall = false;
        let newDirection = "right";
        let lastDirection = "right";
        let score = 0;
        const scoreDisplay = document.getElementById('score');
        scoreDisplay.textContent = score;
        let speed = Math.max(300 - score * 5, 60);
        const speedDisplay = document.getElementById('speed');
        speedDisplay.textContent = speed;
        gridMatrix[9][9] = 1; // Add to the grid
        gridMatrix[8][9] = 2;

        // Initially add a single food
        addNewFood();

        // Initially draw the grid, snake, and food
        draw();

        // Add food to a random location
        function addNewFood() {
            let found = false;

            // Put a food in a 0 location
            do {
                let newFoodLocation = [Math.floor(Math.random() * gridSize), Math.floor(Math.random() * gridSize)];
                if (gridMatrix[newFoodLocation[0]][newFoodLocation[1]] === 0) {
                    gridMatrix[newFoodLocation[0]][newFoodLocation[1]] = 3;
                    found = true;
                }
            } while (found === false);
        }

        // Move the snake based on the direction
        function moveSnake(ateFood) {
            let newHead = [snake[0][0], snake[0][1]]; // Duplicate the current head

            // Logic for updating new head position based on direction
            // Can't move backwards
            if (newDirection === "right") {
                if (lastDirection === "left") {
                    newHead[0] -= 1;
                } else {
                    newHead[0] += 1;
                    lastDirection = newDirection;
                }
            }

            if (newDirection === "left") {
                if (lastDirection === "right") {
                    newHead[0] += 1;
                } else {
                    newHead[0] -= 1;
                    lastDirection = newDirection;
                }
            }

            if (newDirection === "up") {
                if (lastDirection === "down") {
                    newHead[1] += 1;
                } else {
                    newHead[1] -= 1;
                    lastDirection = newDirection;
                }
            }

            if (newDirection === "down") {
                if (lastDirection === "up") {
                    newHead[1] -= 1;
                } else {
                    newHead[1] += 1;
                    lastDirection = newDirection;
                }
            }

            // Check wall collisions
            if (
                newHead[0] < 0 || newHead[0] >= gridSize ||
                newHead[1] < 0 || newHead[1] >= gridSize
            ) {
                hitWall = true;
                return;
            }

            // Check tail collisions
            if (gridMatrix[newHead[0]][newHead[1]] === 2) {
                hitTail = true;
            }

            // Check food collisions
            if (gridMatrix[newHead[0]][newHead[1]] === 3) {
                ateFood = true;
            }

            // Update the grid with new head
            gridMatrix[newHead[0]][newHead[1]] = 1;

            // Update the grid to have the old head become a tail; 1 -> 2
            gridMatrix[snake[0][0]][snake[0][1]] = 2;

            // Update the snake array with new head
            // Add new head at the front
            snake.unshift(newHead);

            if (ateFood) {
                addNewFood();
                score += 1;
                scoreDisplay.textContent = score;
                speed = Math.max(300 - score * 10, 60); // Speed up as score increases
                speedDisplay.textContent = speed;
            } else {
                let tail = snake.pop(); // Remove tail
                gridMatrix[tail[0]][tail[1]] = 0; // Clear tail from grid
            }
        }

        // Create a square array and return
        function createMatrix(sideLength) {
            const dynamic2DArray = [];

            for (let i = 0; i < sideLength; i++) {
                dynamic2DArray[i] = []; // Initialize a new inner array for each row
                for (let j = 0; j < sideLength; j++) {
                    // Filling all postitions with 0; 1 represents snake head; 2 represents snake tail; 3 represents food
                    dynamic2DArray[i][j] = 0;
                }
            }
            return dynamic2DArray;
        }

        // Draw
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear the canvas
            ctx.fillStyle = "white"; // white lines as background
            ctx.fillRect(0, 0, canvas.width, canvas.height); // Fill the background
            drawEverything(); // Dark red snake head, red snake tail, green food

            // Draw Snake and Food
            function drawEverything() {
                for (let i = 0; i < gridSize; i++) {
                    for (let j = 0; j < gridSize; j++) {
                        // Empty postitions represent 0; 1 represents snake head; 2 represents snake tail; 3 represents food

                        if (gridMatrix[i][j] === 1) { // Snake Head
                            ctx.fillStyle = "rgb(255, 68, 0)";
                            ctx.fillRect(i * gridSize, j * gridSize, gridSize - 0.5, gridSize - 0.5);
                        }
                        else if (gridMatrix[i][j] === 2) { // Snake Tail
                            ctx.fillStyle = "rgb(244, 154, 35)";
                            ctx.fillRect(i * gridSize, j * gridSize, gridSize - 0.5, gridSize - 0.5);
                        }
                        else if (gridMatrix[i][j] === 3) { // Food
                            ctx.fillStyle = "rgb(0, 182, 6)";
                            ctx.fillRect(i * gridSize, j * gridSize, gridSize - 0.5, gridSize - 0.5);
                        } else {
                            ctx.fillStyle = "rgb(67, 67, 67)";
                            ctx.fillRect(i * gridSize, j * gridSize, gridSize - 0.5, gridSize - 0.5);
                        }
                    }
                }
                // Draw extra border to help outline
                ctx.strokeStyle = "rgb(124, 0, 0)";
                ctx.lineWidth = 1.5;
                ctx.strokeRect(0, 0, canvas.width, canvas.height); // Draw border
            }
        }

        // Store the timeout ID for the game loop
        let gameLoopTimeoutId = null;

        // Only add the keydown event listener once
        let keyListenerAdded = false;

        // Function to reset game state
        function resetGame() {
            // Reset core variables
            snake = [
                [9, 9],
                [8, 9]
            ];
            lastDirection = 'right';
            newDirection = "right";
            ateFood = false;
            hitTail = false;
            hitWall = false;
            gridMatrix = createMatrix(gridSize);
            gameStarted = false;
            score = 0;
            scoreDisplay.textContent = score;
            speed = Math.max(300 - score * 5, 60);
            speedDisplay.textContent = speed;

            // Place snake on grid
            gridMatrix[9][9] = 1;
            gridMatrix[8][9] = 2;

            addNewFood();

            // Clear canvas
            ctx.clearRect(0, 0, 400, 400);

            // Cancel the current game loop if it exists
            if (gameLoopTimeoutId) {
                clearTimeout(gameLoopTimeoutId);
                gameLoopTimeoutId = null;
            }

            draw();
        }

        // Loop the game
        function gameLoop() {
            // Start the game
            gameStarted = true;

            // Add keydown event listener only once
            if (!keyListenerAdded) {
                document.addEventListener('keydown', (event) => {
                    // Don't block typing if an input is focused
                    if (document.activeElement.tagName === 'INPUT') return;

                    switch (event.key) {
                        case 'ArrowUp':
                            if (lastDirection !== 'down') newDirection = "up";
                            break;
                        case 'ArrowDown':
                            if (lastDirection !== 'up') newDirection = "down";
                            break;
                        case 'ArrowLeft':
                            if (lastDirection !== 'right') newDirection = "left";
                            break;
                        case 'ArrowRight':
                            if (lastDirection !== 'left') newDirection = "right";
                            break;
                        default:
                            return; // Ignore other keys
                    }

                    event.preventDefault(); // Only prevent default for arrow keys
                });

                keyListenerAdded = true;
            }

            // Move the snake first to get new head position
            moveSnake(ateFood);
            ateFood = false;

            // Now get the new head
            let newHead = snake[0];

            // Check for wall and tail collisions
            if (hitWall || hitTail) {
                gameStarted = false;
                handleGameOver(); // <-- call leaderboard submission
                return; // Don't continue the loop
            }

            draw();

            // Speed up as the score increases (minimum 60ms interval)
            speed = Math.max(300 - score * 5, 10);
            speedDisplay.textContent = speed;
            gameLoopTimeoutId = setTimeout(gameLoop, speed);
        }

        // Helper function to submit score to backend
        async function submitScore(name, score) {
            try {
                const response = await fetch("https://leaderboard-backend-esd8.onrender.com/scores", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ name, score })
                });

                const data = await response.json();
                console.log("Score saved:", data);
                fetchLeaderboard(); // refresh leaderboard after submission
            } catch (err) {
                console.error("Error submitting score:", err);
            }
        }

        let dotCount = 0;
        let loadingInterval;

        // Start loading animation for leaderboard
        function startLoadingAnimation() {
            const dots = document.getElementById("loadingDots");
            dotCount = 0;
            loadingInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4; // cycles 0,1,2,3
                dots.textContent = ".".repeat(dotCount);
            }, 500);
        }

        // Stop loading animation for leaderboard
        function stopLoadingAnimation() {
            clearInterval(loadingInterval);
            const dots = document.getElementById("loadingDots");
            if (dots) dots.textContent = "";
        }

        // Fetch leaderboard and update HTML
        async function fetchLeaderboard(currentPlayerScore = null) {
            try {
                // Show loading row + start animation
                const leaderboardBody = document.getElementById("leaderboardBody");
                leaderboardBody.innerHTML = `
                    <tr id="loadingRow">
                    <td colspan="4" style="text-align:center;">(ext time <20s) Loading<span id="loadingDots"></span></td>
                    </tr>
                `;
                startLoadingAnimation();

                const response = await fetch("https://leaderboard-backend-esd8.onrender.com/scores");
                const scores = await response.json();

                stopLoadingAnimation();
                leaderboardBody.innerHTML = ""; // clear loading row

                // Sort descending
                scores.sort((a, b) => b.score - a.score);
                const topScores = scores.slice(0, 5); // Get top 5 scores

                let isTop10 = false;

                // Find distinct top scores for medal positions
                const medalScores = [];
                for (let i = 0; i < topScores.length; i++) {
                    if (!medalScores.includes(topScores[i].score)) {
                        medalScores.push(topScores[i].score);
                    }
                    if (medalScores.length === 3) break; // only need top 3 unique scores
                }

                topScores.forEach((entry, index) => {
                    const row = document.createElement("tr");
                    const dateStr = entry.date ? new Date(entry.date).toLocaleString() : "N/A";

                    // Decide background color based on score group
                    let bgColor = "";
                    if (entry.score === medalScores[0]) bgColor = "gold";
                    else if (medalScores[1] !== undefined && entry.score === medalScores[1]) bgColor = "silver";
                    else if (medalScores[2] !== undefined && entry.score === medalScores[2]) bgColor = "#cd7f32";

                    row.innerHTML = `
        <td>${index + 1}</td>
        <td>${entry.name}</td>
        <td>${entry.score}</td>
        <td>${dateStr}</td>
    `;
                    if (bgColor) row.style.backgroundColor = bgColor;

                    leaderboardBody.appendChild(row);
                });

                // Show input box if player scored in top 10
                const scoreInputDiv = document.getElementById("scoreInputDiv");
                if (isTop10 && currentPlayerScore !== null) {
                    scoreInputDiv.style.display = "block";
                    document.getElementById("playerNameInput").focus();
                } else {
                    scoreInputDiv.style.display = "none";
                }

            } catch (err) {
                console.error("Error fetching leaderboard:", err);
            }
        }

        // Call this when the game ends
        function handleGameOver() {
            // Check if score qualifies for top 10
            fetch("https://leaderboard-backend-esd8.onrender.com/scores")
                .then(res => res.json())
                .then(scores => {
                    scores.sort((a, b) => b.score - a.score);
                    const topScores = scores.slice(0, 10);
                    const minTopScore = topScores.length < 10 ? 0 : topScores[topScores.length - 1].score;

                    const scoreInputDiv = document.getElementById("scoreInputDiv");
                    const nameInput = document.getElementById("playerNameInput");

                    if (score > minTopScore) {
                        // Show input box
                        scoreInputDiv.style.display = "block";
                        nameInput.focus(); // <-- Auto-focus here
                    } else {
                        // Just reset the game
                        resetGame();
                    }
                });
        }

        // Handle start button
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!gameStarted) {
                gameLoop();
            }
        });

        // Handle reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            resetGame();
        });

        // Handle score submission
        document.getElementById("submitScoreBtn").addEventListener("click", () => {
            const nameInput = document.getElementById("playerNameInput");
            const playerName = nameInput.value.trim();
            if (playerName) {
                submitScore(playerName, score);
                nameInput.value = ""; // clear input
                document.getElementById("scoreInputDiv").style.display = "none";
                resetGame();
            }
        });

        // Load leaderboard when page loads
        fetchLeaderboard();
    </script>
</body>

</html>